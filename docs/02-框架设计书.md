# 婚纱照选片工具 - 框架设计书

## 1. 技术架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        PhotoPicker Pro                          │
│                      (Tauri + React App)                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   UI Layer  │  │  State Mgmt │  │   Services  │             │
│  │   (React)   │  │  (Zustand)  │  │  (Custom)   │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
│         │                │                │                     │
│  ┌──────▼────────────────▼────────────────▼──────┐             │
│  │              Frontend Core                    │             │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐        │             │
│  │  │ Photo   │ │ Compare │ │ Import  │        │             │
│  │  │ Grid    │ │ View    │ │ Manager │        │             │
│  │  └─────────┘ └─────────┘ └─────────┘        │             │
│  └───────────────────────────────────────────────┘             │
│                          │                                      │
│  ════════════════════════╪══════════════════════════            │
│                          │ (IPC Bridge)                        │
│  ════════════════════════╪══════════════════════════            │
│                          │                                      │
│  ┌───────────────────────▼───────────────────────┐             │
│  │              Tauri Backend (Rust)             │             │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐        │             │
│  │  │ File    │ │ Thumbnail│ │ Export  │        │             │
│  │  │ System  │ │ Generator│ │ Manager │        │             │
│  │  └─────────┘ └─────────┘ └─────────┘        │             │
│  └───────────────────────────────────────────────┘             │
│                          │                                      │
│  ┌───────────────────────▼───────────────────────┐             │
│  │              OS File System                   │             │
│  └───────────────────────────────────────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 前端架构 (React)

### 2.1 目录结构

```
src/
├── components/                 # 组件目录
│   ├── common/                # 通用组件
│   │   ├── Button/
│   │   ├── Modal/
│   │   ├── Tooltip/
│   │   └── Loading/
│   ├── layout/                # 布局组件
│   │   ├── Header/
│   │   ├── Sidebar/
│   │   ├── MainContent/
│   │   └── StatusBar/
│   ├── photo/                 # 照片相关组件
│   │   ├── PhotoGrid/
│   │   ├── PhotoCard/
│   │   ├── PhotoPreview/
│   │   └── PhotoGroup/
│   ├── compare/               # 对比功能组件
│   │   ├── CompareView/
│   │   ├── CompareSelector/
│   │   └── SyncControls/
│   └── import/                # 导入功能组件
│       ├── DropZone/
│       ├── ImportProgress/
│       └── FolderBrowser/
├── hooks/                     # 自定义 Hooks
│   ├── usePhotos.ts          # 照片管理
│   ├── useGroups.ts          # 分组管理
│   ├── useCompare.ts         # 对比功能
│   ├── useKeyboard.ts        # 键盘快捷键
│   ├── useAnimation.ts       # 动画控制
│   └── useImport.ts          # 导入功能
├── stores/                    # 状态管理 (Zustand)
│   ├── photoStore.ts         # 照片状态
│   ├── groupStore.ts         # 分组状态
│   ├── uiStore.ts            # UI 状态
│   └── settingsStore.ts      # 设置状态
├── services/                  # 服务层
│   ├── tauri/                # Tauri IPC 调用
│   │   ├── fileService.ts
│   │   ├── thumbnailService.ts
│   │   └── exportService.ts
│   └── local/                # 本地服务
│       ├── storageService.ts
│       └── cacheService.ts
├── types/                     # TypeScript 类型定义
│   ├── photo.ts
│   ├── group.ts
│   └── settings.ts
├── utils/                     # 工具函数
│   ├── constants.ts
│   ├── helpers.ts
│   └── validators.ts
├── styles/                    # 样式文件
│   ├── globals.css
│   ├── variables.css
│   └── animations.css
└── App.tsx                    # 应用入口
```

### 2.2 核心组件设计

#### PhotoCard 组件
```typescript
interface PhotoCardProps {
  photo: Photo;
  isSelected: boolean;
  isDragging: boolean;
  onSelect: (id: string) => void;
  onDoubleClick: (id: string) => void;
  onDragStart: (id: string) => void;
  animationState: 'idle' | 'moving' | 'deleting' | 'appearing';
}
```

#### PhotoGrid 组件
```typescript
interface PhotoGridProps {
  photos: Photo[];
  groupId: string;
  layout: 'grid' | 'list';
  columns: number;
  selectedIds: string[];
  onSelectionChange: (ids: string[]) => void;
  onPhotoMove: (photoIds: string[], targetGroup: string) => void;
}
```

#### CompareView 组件
```typescript
interface CompareViewProps {
  leftPhoto: Photo | null;
  rightPhoto: Photo | null;
  leftGroup: string;
  rightGroup: string;
  onPhotoChange: (side: 'left' | 'right', photo: Photo | null) => void;
  onDecision: (decision: 'keep' | 'delete', photoId: string) => void;
  onClose: () => void;
}
```

---

## 3. 状态管理设计 (Zustand)

### 3.1 Store 划分

```typescript
// photoStore.ts - 照片状态
interface PhotoState {
  photos: Map<string, Photo>;
  selectedIds: Set<string>;
  loadingIds: Set<string>;

  // Actions
  addPhotos: (photos: Photo[]) => void;
  removePhotos: (ids: string[]) => void;
  updatePhoto: (id: string, updates: Partial<Photo>) => void;
  selectPhoto: (id: string, multi?: boolean) => void;
  clearSelection: () => void;
  movePhotos: (ids: string[], targetGroup: string) => void;
}

// groupStore.ts - 分组状态
interface GroupState {
  groups: Group[];
  activeGroupId: string;

  // Actions
  createGroup: (name: string) => void;
  deleteGroup: (id: string) => void;
  setActiveGroup: (id: string) => void;
  reorderGroups: (ids: string[]) => void;
}

// uiStore.ts - UI 状态
interface UIState {
  viewMode: 'grid' | 'compare';
  sidebarCollapsed: boolean;
  zoomLevel: number;
  isImporting: boolean;
  importProgress: number;
  notification: Notification | null;

  // Actions
  setViewMode: (mode: 'grid' | 'compare') => void;
  toggleSidebar: () => void;
  setZoomLevel: (level: number) => void;
  showNotification: (notification: Notification) => void;
}

// compareStore.ts - 对比状态
interface CompareState {
  isComparing: boolean;
  leftPhotoId: string | null;
  rightPhotoId: string | null;
  leftGroupId: string;
  rightGroupId: string;
  syncZoom: boolean;
  syncPan: boolean;

  // Actions
  startCompare: (leftId: string, rightId: string) => void;
  endCompare: () => void;
  setLeftPhoto: (id: string | null) => void;
  setRightPhoto: (id: string | null) => void;
  toggleSyncZoom: () => void;
  toggleSyncPan: () => void;
}
```

---

## 4. 后端架构 (Tauri/Rust)

### 4.1 目录结构

```
src-tauri/
├── src/
│   ├── main.rs               # 应用入口
│   ├── lib.rs                # 库入口
│   ├── commands/             # IPC 命令
│   │   ├── file_commands.rs  # 文件操作命令
│   │   ├── photo_commands.rs # 照片处理命令
│   │   ├── export_commands.rs# 导出命令
│   │   └── system_commands.rs# 系统命令
│   ├── services/             # 服务层
│   │   ├── file_service.rs   # 文件服务
│   │   ├── thumbnail_service.rs # 缩略图服务
│   │   ├── metadata_service.rs  # 元数据服务
│   │   └── export_service.rs    # 导出服务
│   ├── models/               # 数据模型
│   │   ├── photo.rs
│   │   ├── group.rs
│   │   └── settings.rs
│   ├── utils/                # 工具函数
│   │   ├── image_utils.rs
│   │   ├── path_utils.rs
│   │   └── error_utils.rs
│   └── state/                # 应用状态
│       └── app_state.rs
├── Cargo.toml
└── tauri.conf.json
```

### 4.2 核心命令设计

```rust
// file_commands.rs
#[tauri::command]
async fn scan_directory(path: String) -> Result<Vec<PhotoInfo>, Error>;

#[tauri::command]
async fn read_image_metadata(path: String) -> Result<ImageMetadata, Error>;

// photo_commands.rs
#[tauri::command]
async fn generate_thumbnail(path: String, size: u32) -> Result<String, Error>;

#[tauri::command]
async fn batch_generate_thumbnails(paths: Vec<String>) -> Result<Progress, Error>;

// export_commands.rs
#[tauri::command]
async fn export_selection(photo_ids: Vec<String>, target_path: String) -> Result<(), Error>;

#[tauri::command]
async fn generate_report(group_id: String) -> Result<Report, Error>;
```

---

## 5. 数据流设计

### 5.1 照片导入流程

```
用户拖拽文件夹
    │
    ▼
┌─────────────────┐
│  DropZone 组件   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│ 调用 Tauri API  │────▶│ scan_directory  │
│  scan_directory │     │ 扫描目录文件     │
└────────┬────────┘     └────────┬────────┘
         │                       │
         │                       ▼
         │              ┌─────────────────┐
         │              │ 过滤照片文件     │
         │              │ 提取元数据       │
         │              └────────┬────────┘
         │                       │
         ▼                       │
┌─────────────────┐              │
│ 返回 PhotoInfo  │◀─────────────┘
│     列表        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 异步生成缩略图   │
│ 显示进度条       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 更新 photoStore │
│ 渲染照片网格     │
└─────────────────┘
```

### 5.2 照片移动流程

```
用户操作 (点击/快捷键/拖拽)
    │
    ▼
┌─────────────────┐
│ 触发 movePhotos │
│    Action       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 设置动画状态     │
│ (moving → target)│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 播放移动动画     │
│ (Framer Motion) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 更新 photo.group│
│ 更新 group 计数  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 动画完成回调     │
│ 重新渲染列表     │
└─────────────────┘
```

---

## 6. 动画系统设计

### 6.1 动画库选择
- **Framer Motion**: 主要动画库，用于组件动画、布局动画
- **CSS Transitions**: 简单过渡效果
- **Web Animations API**: 复杂序列动画

### 6.2 动画规范

| 动画类型 | 持续时间 | 缓动函数 | 说明 |
|----------|----------|----------|------|
| 照片选中 | 200ms | ease-out | 缩放 1.0 → 1.05 |
| 照片移动 | 400ms | cubic-bezier(0.4, 0, 0.2, 1) | 飞入目标区域 |
| 照片删除 | 300ms | ease-in | 缩小 + 淡出 |
| 分组切换 | 250ms | ease-in-out | 淡入淡出 |
| 导入渐显 | 150ms | ease-out | 透明度 0 → 1 |
| 模态框弹出 | 200ms | spring | 缩放 + 淡入 |

### 6.3 动画实现示例

```typescript
// 照片移动动画
const moveAnimation = {
  initial: { scale: 1, opacity: 1 },
  animate: (targetRect: DOMRect) => ({
    x: targetRect.x - currentRect.x,
    y: targetRect.y - currentRect.y,
    scale: 0.8,
    opacity: 0,
  }),
  transition: {
    duration: 0.4,
    ease: [0.4, 0, 0.2, 1],
  },
  onAnimationComplete: () => {
    // 实际移动数据
    movePhoto(photoId, targetGroup);
  },
};
```

---

## 7. 性能优化策略

### 7.1 前端优化
- **虚拟列表**: 照片数量 > 100 时使用 react-window
- **图片懒加载**: 视口外照片不加载
- **缩略图缓存**: 已生成的缩略图缓存在 IndexedDB
- **防抖节流**: 滚动、缩放等高频事件处理
- **Memoization**: 组件和计算结果缓存

### 7.2 后端优化
- **缩略图预生成**: 后台线程异步生成
- **多线程处理**: 利用 Rust 并发处理图片
- **文件系统监听**: 监听目录变化，增量更新

### 7.3 内存管理
- **照片对象池**: 复用照片对象
- **缩略图 LRU 缓存**: 限制内存中的缩略图数量
- **大图片释放**: 离开视口一定距离后释放大图

---

## 8. 错误处理设计

### 8.1 错误类型

```typescript
enum ErrorType {
  FILE_NOT_FOUND = 'FILE_NOT_FOUND',
  PERMISSION_DENIED = 'PERMISSION_DENIED',
  INVALID_FORMAT = 'INVALID_FORMAT',
  THUMBNAIL_FAILED = 'THUMBNAIL_FAILED',
  IMPORT_INTERRUPTED = 'IMPORT_INTERRUPTED',
  EXPORT_FAILED = 'EXPORT_FAILED',
  STORAGE_FULL = 'STORAGE_FULL',
}

interface AppError {
  type: ErrorType;
  message: string;
  details?: string;
  recoverable: boolean;
}
```

### 8.2 错误处理流程
- 后端错误 → IPC 传递 → 前端统一处理 → UI 提示
- 可恢复错误：提供重试/忽略选项
- 不可恢复错误：记录日志，友好提示

---

**文档版本**: v1.0
**创建日期**: 2026-01-28
**最后更新**: 2026-01-28
